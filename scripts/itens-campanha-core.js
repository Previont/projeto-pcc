;(function(){
  function truncarNomeArquivo(nome, maxLength){ if (nome.length <= maxLength) return nome; var ext = nome.split('.').pop(); var base = nome.slice(0, -(ext.length + 1)); return base.slice(0, maxLength - ext.length - 4) + '...' + ext }
  function validarArquivo(file){ var maxSize = 5*1024*1024; var allowed = ['image/jpeg','image/jpg','image/png','image/gif']; if(!file) return {valido:false,erro:'Nenhum arquivo selecionado'}; if(allowed.indexOf(file.type)===-1) return {valido:false,erro:'Tipo de arquivo não permitido. Use JPG, PNG ou GIF.'}; if(file.size>maxSize) return {valido:false,erro:'Arquivo muito grande. Tamanho máximo: 5MB.'}; return {valido:true} }
  function mostrarCarregamento(container){ var label = container.querySelector('.file-label'); if(label){ label.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Carregando...</span>'; label.style.pointerEvents = 'none' } }
  function esconderCarregamento(container){ var label = container.querySelector('.file-label'); if(label){ label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Escolher imagem</span>'; label.style.pointerEvents = 'auto' } }
  function exibirInfoArquivo(container, file){ var info = container.querySelector('.file-info'); if(!info){ info = document.createElement('div'); info.className = 'file-info'; info.style.display = 'flex'; info.style.alignItems = 'center'; info.style.justifyContent = 'space-between'; info.style.padding = '8px 12px'; info.style.backgroundColor = '#2C2C2C'; info.style.border = '1px solid #555'; info.style.borderRadius = '4px'; info.style.marginTop = '5px'; var nome = document.createElement('span'); nome.className = 'file-name'; nome.style.color = '#E0E0E0'; nome.style.fontSize = '12px'; nome.style.maxWidth = '80%'; nome.style.overflow = 'hidden'; nome.style.textOverflow = 'ellipsis'; nome.style.whiteSpace = 'nowrap'; var btnRemover = document.createElement('button'); btnRemover.type = 'button'; btnRemover.className = 'btn-remover-imagem'; btnRemover.title = 'Remover imagem'; btnRemover.innerHTML = '<i class="fas fa-times"></i>'; btnRemover.style.backgroundColor = '#e74c3c'; btnRemover.style.color = 'white'; btnRemover.style.border = 'none'; btnRemover.style.borderRadius = '50%'; btnRemover.style.width = '20px'; btnRemover.style.height = '20px'; btnRemover.style.cursor = 'pointer'; btnRemover.style.fontSize = '10px'; btnRemover.style.marginLeft = '8px'; btnRemover.onclick = function(e){ e.stopPropagation(); limparPreview(container) }; info.appendChild(nome); info.appendChild(btnRemover); container.appendChild(info) } var nomeEl = info.querySelector('.file-name'); if(nomeEl){ nomeEl.textContent = truncarNomeArquivo(file.name, 25) } }
  function exibirErro(container, mensagem){ var erroDiv = container.querySelector('.erro-imagem'); if(!erroDiv){ erroDiv = document.createElement('div'); erroDiv.className = 'erro-imagem'; erroDiv.style.color = '#e74c3c'; erroDiv.style.fontSize = '12px'; erroDiv.style.marginTop = '5px'; erroDiv.style.padding = '5px 8px'; erroDiv.style.backgroundColor = 'rgba(231, 76, 60, 0.1)'; erroDiv.style.border = '1px solid rgba(231, 76, 60, 0.3)'; erroDiv.style.borderRadius = '4px'; container.appendChild(erroDiv) } erroDiv.textContent = mensagem; erroDiv.style.display = 'block'; container.classList.add('has-error'); setTimeout(function(){ if(erroDiv.parentNode){ erroDiv.remove() } }, 5000) }
  function criarPreview(container, file){ var reader = new FileReader(); reader.onload = function(e){ var preview = container.querySelector('.preview-imagem'); if(!preview){ preview = document.createElement('div'); preview.className = 'preview-imagem'; preview.style.display = 'block'; preview.style.marginTop = '8px'; preview.style.textAlign = 'center'; var img = document.createElement('img'); img.className = 'preview-img'; img.style.maxWidth = '200px'; img.style.maxHeight = '150px'; img.style.border = '1px solid #555'; img.style.borderRadius = '4px'; img.style.padding = '5px'; var overlay = document.createElement('div'); overlay.className = 'preview-overlay'; overlay.style.position = 'absolute'; overlay.style.top = '0'; overlay.style.left = '0'; overlay.style.right = '0'; overlay.style.bottom = '0'; overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.opacity = '0'; overlay.style.transition = 'opacity 0.3s ease'; var btnTrocar = document.createElement('button'); btnTrocar.type = 'button'; btnTrocar.className = 'btn-trocar-imagem'; btnTrocar.title = 'Trocar imagem'; btnTrocar.innerHTML = '<i class="fas fa-camera"></i>'; btnTrocar.style.backgroundColor = '#42a5f5'; btnTrocar.style.color = 'white'; btnTrocar.style.border = 'none'; btnTrocar.style.borderRadius = '50%'; btnTrocar.style.width = '40px'; btnTrocar.style.height = '40px'; btnTrocar.style.cursor = 'pointer'; btnTrocar.onclick = function(ev){ ev.stopPropagation(); var fileInput = container.querySelector('input[type="file"]'); if(fileInput){ fileInput.click() } }; preview.style.position = 'relative'; overlay.appendChild(btnTrocar); preview.appendChild(img); preview.appendChild(overlay); preview.onmouseenter = function(){ overlay.style.opacity = '1' }; preview.onmouseleave = function(){ overlay.style.opacity = '0' } } var imgEl = preview.querySelector('.preview-img'); imgEl.src = e.target.result; if(!preview.parentNode){ container.appendChild(preview) } }; reader.readAsDataURL(file) }
  function atualizarBotaoUpload(container, file){ var label = container.querySelector('.file-label'); if(label){ var nomeTrunc = truncarNomeArquivo(file.name, 30); label.innerHTML = '<i class="fas fa-image"></i><span>'+nomeTrunc+'</span>'; label.title = file.name; label.classList.add('arquivo-selecionado') } }
  function definirImagemFundo(container, file){ var reader = new FileReader(); reader.onload = function(e){ var item = container.closest('.item-campanha'); if(!item) return; item.classList.add('com-imagem'); item.style.backgroundImage = 'url('+e.target.result+')'; item.style.backgroundSize = 'cover'; item.style.backgroundPosition = 'center'; item.style.backgroundRepeat = 'no-repeat'; var overlay = item.querySelector('.imagem-overlay') || document.createElement('div'); overlay.className = 'imagem-overlay'; overlay.style.position = 'absolute'; overlay.style.top = '0'; overlay.style.left = '0'; overlay.style.right = '0'; overlay.style.bottom = '0'; overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.6)'; overlay.style.zIndex = '1'; overlay.style.borderRadius = '6px'; if(!overlay.parentNode){ item.insertBefore(overlay, item.firstChild) } var campos = item.querySelector('.item-campos'); if(campos){ campos.style.position = 'relative'; campos.style.zIndex = '2' } var header = item.querySelector('.item-header'); if(header){ header.style.position = 'relative'; header.style.zIndex = '2' } }; reader.readAsDataURL(file) }
  function limparPreview(container){ var preview = container.querySelector('.preview-imagem'); var info = container.querySelector('.file-info'); var input = container.querySelector('input[type="file"]'); if(preview) preview.remove(); if(info) info.remove(); if(input) input.value=''; var label = container.querySelector('.file-label'); if(label){ label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Escolher imagem</span>'; label.title = ''; label.classList.remove('arquivo-selecionado') } var item = container.closest('.item-campanha'); if(item){ item.classList.remove('com-imagem'); item.style.backgroundImage=''; item.style.backgroundSize=''; item.style.backgroundPosition=''; item.style.backgroundRepeat=''; var ov = item.querySelector('.imagem-overlay'); if(ov){ ov.remove() } var campos = item.querySelector('.item-campos'); if(campos){ campos.style.position=''; campos.style.zIndex='' } var header = item.querySelector('.item-header'); if(header){ header.style.position=''; header.style.zIndex='' } } container.classList.remove('has-success','has-error'); limparEstados(container) }
  function limparEstados(container){ var erroDiv = container.querySelector('.erro-imagem'); if(erroDiv){ erroDiv.style.display = 'none' } container.classList.remove('has-error') }
  function validarValorItem(input){ var valor = parseFloat(input.value); var item = input.closest('.item-campanha'); input.classList.remove('invalid','valid'); if(input.value===''){ return } if(isNaN(valor) || valor<=0){ input.classList.add('invalid'); if(!item.querySelector('.erro-valor')){ var erroMsg = document.createElement('span'); erroMsg.className='erro-valor'; erroMsg.textContent='O valor deve ser um número positivo'; erroMsg.style.color='#e74c3c'; erroMsg.style.fontSize='12px'; erroMsg.style.marginTop='5px'; erroMsg.style.display='block'; input.parentNode.appendChild(erroMsg) } } else { input.classList.add('valid'); var erroMsg = item.querySelector('.erro-valor'); if(erroMsg){ erroMsg.remove() } } }
  function processarUploadImagem(inputFile){ var file = inputFile.files[0]; var container = inputFile.closest('.upload-container') || inputFile.closest('.form-group'); if(!file) return; limparEstados(container); mostrarCarregamento(container); var valid = validarArquivo(file); if(!valid.valido){ esconderCarregamento(container); exibirErro(container, valid.erro); inputFile.value=''; return } setTimeout(function(){ esconderCarregamento(container); criarPreview(container, file); exibirInfoArquivo(container, file); atualizarBotaoUpload(container, file); definirImagemFundo(container, file); container.classList.add('has-success') }, 300) }
  function renumerarItens(lista, opts){ var skipRemoved = !!(opts && opts.skipRemoved); var itens = lista.querySelectorAll(skipRemoved ? '.item-campanha:not(.item-removido)' : '.item-campanha'); for(var i=0;i<itens.length;i++){ var item = itens[i]; var titulo = item.querySelector('h4'); if(titulo){ titulo.textContent = 'Item '+(i+1) } } }
  window.ItensCampanhaCore = { renumerarItens: renumerarItens, validarValorItem: validarValorItem, processarUploadImagem: processarUploadImagem, limparEstados: limparEstados, exibirErro: exibirErro, exibirInfoArquivo: exibirInfoArquivo, limparPreview: limparPreview }
})();

